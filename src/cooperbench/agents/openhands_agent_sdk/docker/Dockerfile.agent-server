# OpenHands Agent-Server Layer for CooperBench Images
# 
# This Dockerfile layers the OpenHands agent-server ON TOP of existing
# CooperBench task images. It uses `uv` to install Python 3.12 in a
# separate venv, so the task's original Python/runtime is preserved.
#
# Supported base images:
#   - Debian/Ubuntu-based (python:3.x-slim, rust:x-slim, node:x-slim)
#   - Alpine-based (golang:x-alpine)
#
# Build with:
#   docker buildx build \
#     --platform linux/amd64,linux/arm64 \
#     --build-arg BASE_IMAGE=akhatua/cooperbench-llama-index:task17244 \
#     -t akhatua/cooperbench-llama-index:task17244-oh \
#     -f Dockerfile.agent-server \
#     --push .

ARG BASE_IMAGE
FROM ${BASE_IMAGE}

# Install curl if not present (needed for uv install)
RUN if command -v apk > /dev/null 2>&1; then \
        apk add --no-cache curl; \
    elif command -v apt-get > /dev/null 2>&1; then \
        apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*; \
    fi

# Install uv and create venv with Python 3.12 in a single layer
# UV_INSTALL_DIR controls where uv binary goes
ENV UV_INSTALL_DIR=/opt/uv
ENV AGENT_VENV=/opt/agent-server-venv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    . /opt/uv/env && \
    uv venv --python 3.12 ${AGENT_VENV} && \
    uv pip install --python ${AGENT_VENV}/bin/python \
        openhands-agent-server \
        openhands-sdk \
        openhands-tools \
        redis

# Copy local OpenHands SDK packages (for custom tools)
COPY openhands-sdk /opt/openhands/openhands-sdk
COPY openhands-tools /opt/openhands/openhands-tools
COPY openhands-workspace /opt/openhands/openhands-workspace

# Install local packages into the agent venv (override PyPI versions)
RUN . /opt/uv/env && uv pip install --python ${AGENT_VENV}/bin/python \
        -e /opt/openhands/openhands-sdk \
        -e /opt/openhands/openhands-tools \
        -e /opt/openhands/openhands-workspace

# Set working directory for the agent
WORKDIR /workspace/repo

# The agent-server listens on port 8000
EXPOSE 8000

# Run agent-server from the Python 3.12 venv
# Task code still uses the original Python/runtime when executed via terminal
ENTRYPOINT ["/opt/agent-server-venv/bin/python", "-m", "openhands.agent_server", "--host", "0.0.0.0", "--port", "8000"]
